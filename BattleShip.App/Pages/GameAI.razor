@page "/PlayervsIA"
@using Battleship.Models
@using System.Net.Http.Json;
@inject HttpClient HttpClient

<link rel="stylesheet" href="css/home.css">
<link rel="stylesheet" href="css/grid.css">

<a href="/" class="back-btn">Menu</a>

<div class="@(hardModeState ? "grid-hard-container-player" : "grid-container-player")" id="playerGrid">
    @if (model != null)
    {
        @for (int col = 0; col < gridSize; col++)
        {
            for (int row = 0; row < gridSize; row++)
            {
                var boat = GetBoatAtPosition(model.BoatList, col, row);
                var isOccupied = boat != null;
                var cellState = playerGrid[col, row];
                var clickRow=row;
                var clickCol=col;

                <div class="grid-cell-player @(GetCellCssClass(cellState, isOccupied))" @onclick="() => HandleCellClick(clickCol, clickRow)">
                    @if (isOccupied && cellState == CellState.Untouched)
                    {
                        <span class="boat-name">@boat.Name</span>
                    }
                    else if (cellState == CellState.Hit)
                    {
                        <i class="fa-solid fa-fire" style="color: #ffffff;"></i>
                    }
                </div>
            }
        }
    }
</div>

<label>
    Placement al√©atoire
</label>
<input type="checkbox" @bind="randomPlacement" />

<label>Hard mode</label>
<input type="checkbox" @bind="hardMode" />
<button @onclick="OnNewGameClick">Nouvelle partie</button>


<div class="@(hardModeState ? "grid-hard-container-ia" : "grid-container-ia")" id="iaGrid">
    @for (int col = 0; col < gridSize; col++)
    {
        for (int row = 0; row < gridSize; row++)
        {
            var clickRow = row;
            var clickCol = col;
            var cellState = opponentGrid[col, row];
            <div class="grid-cell-ia @GetCellCssClass(cellState, false)"
                 @onclick="() => HandleCellClick(clickCol, clickRow)">
            </div>
        }
    }
</div>

@code {
    private int gridSize = 10;
    private StartGameAIResponse model;
    private ShootResponse shootModel;
    private CellState[,] opponentGrid = new CellState[10, 10];
    private CellState[,] playerGrid = new CellState[10, 10];
    private List<Boat> playerBoats = new List<Boat>();
    

    private bool randomPlacement = false;
    private bool hardMode = false;
    private bool hardModeState = false;

    protected async Task OnNewGameClick()
    {
        gridSize = hardMode ? 15 : 10;
        hardModeState = hardMode;
        opponentGrid = new CellState[gridSize, gridSize];
        playerGrid = new CellState[gridSize, gridSize];
        if (randomPlacement)
        {
            var url = $"http://localhost:5282/StartGameAI?playerPlacement={randomPlacement}";
            var response = await HttpClient.GetAsync(url);
            model = await response.Content.ReadFromJsonAsync<StartGameAIResponse>();
            // Initialize playerBoats based on the obtained model.BoatList
            playerBoats = model.BoatList.ToList();
        }

        else
        {
            var boats = new Boat[]
            {
                new Boat('A', 1),
                new Boat('B', 2),
                new Boat('C', 3),
                new Boat('D', 4),
                new Boat('E', 4),
                new Boat('F', 4),
                new Boat('G', 4),
            };
        }

        // Update game grids here if necessary

        StateHasChanged(); // Refresh the UI
    }

    private async void HandleCellClick(int col, int row)
    {
        Console.WriteLine($"Clicked at col: {col + 1}, row: {row + 1}"); 
        
        // Check if the cell has already been interacted with
        if (opponentGrid[col, row] != CellState.Untouched) return;
        
        var position = new Position (col, row ); // Ensure Position is correctly instantiated
        var jsonContent = JsonContent.Create(position);
        var response = await HttpClient.PostAsync("http://localhost:5282/Shoot", jsonContent);
        shootModel = await response.Content.ReadFromJsonAsync<ShootResponse>();

        // Update the opponentGrid based on the shoot result
        var x = shootModel.X;
        var y = shootModel.Y;
        opponentGrid[x, y] = shootModel.Hit ? CellState.Hit : CellState.Miss;
        
        // Update the player's grid based on the AI's shoot result
        var aiCol = shootModel.IAShootPosition.X;
        var aiRow = shootModel.IAShootPosition.Y;
        playerGrid[aiCol, aiRow] = shootModel.IAShootHit ? CellState.Hit : CellState.Miss;

        Console.WriteLine($"Result of your shoot: {shootModel.Hit}");
        StateHasChanged();
    }

    private Boat GetBoatAtPosition(IEnumerable<Boat> boats, int col, int row)
    {
        return boats.FirstOrDefault(boat => boat.IsHit(new Position(col, row)));
    }


    // Adjusted GetCellCssClass method to correct the typo
    private string GetCellCssClass(CellState cellState, bool isOccupied)
    {
        return cellState switch
        {
            CellState.Hit => "grid-cell-hit",
            CellState.Miss => "grid-cell-miss",
            _ => isOccupied ? "grid-cell-occupied" : "grid-cell-untouched"
        };
    }

}
